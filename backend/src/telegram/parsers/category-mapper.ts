import { Injectable } from '@nestjs/common';

/**
 * Universal category mapper for bank transactions
 * Maps merchant descriptions to unified categories
 *
 * Categories are synchronized with AI categorization prompt
 */

export interface CategoryMapping {
  name: string;
  icon: string;
  keywords: string[];
}

export interface CategoryResult {
  name: string;
  icon: string;
  confidence: 'high' | 'low';
}

// Universal expense categories (synchronized with AI prompt)
const EXPENSE_CATEGORIES: CategoryMapping[] = [
  {
    name: '–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç—ã',
    icon: 'üõí',
    keywords: [
      'magnit',
      '–º–∞–≥–Ω–∏—Ç',
      'perekrestok',
      '–ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–æ–∫',
      '–ø–µ—Ä–µ–∫—Ä—ë—Å—Ç–æ–∫',
      'pyaterochka',
      '–ø—è—Ç–µ—Ä–æ—á–∫–∞',
      '–ø—è—Ç—ë—Ä–æ—á–∫–∞',
      'lenta',
      '–ª–µ–Ω—Ç–∞',
      'auchan',
      '–∞—à–∞–Ω',
      'metro',
      '–º–µ—Ç—Ä–æ',
      'diksi',
      '–¥–∏–∫—Å–∏',
      'krasnoe&beloe',
      '–∫—Ä–∞—Å–Ω–æ–µ –∏ –±–µ–ª–æ–µ',
      'krasnoe beloe',
      'vkusvill',
      '–≤–∫—É—Å–≤–∏–ª–ª',
      'fixprice',
      '—Ñ–∏–∫—Å –ø—Ä–∞–π—Å',
      'svetofor',
      '—Å–≤–µ—Ç–æ—Ñ–æ—Ä',
      'pobeda',
      '–ø–æ–±–µ–¥–∞',
      'bristol',
      '–±—Ä–∏—Å—Ç–æ–ª—å',
      'okey',
      '–æ–∫–µ–π',
      'spar',
      '—Å–ø–∞—Ä',
      'globus',
      '–≥–ª–æ–±—É—Å',
      'selgros',
      '–∑–µ–ª—å–≥—Ä–æ—Å',
      'azbuka vkusa',
      '–∞–∑–±—É–∫–∞ –≤–∫—É—Å–∞',
      'perekryostok',
      'supermarket',
      '—Å—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç',
      'grocery',
      'produkty',
      '–ø—Ä–æ–¥—É–∫—Ç—ã',
      'magazin',
      '–º–∞–≥–∞–∑–∏–Ω',
      'meridian',
      '–º–µ—Ä–∏–¥–∏–∞–Ω',
      'minimarket',
      '–º–∏–Ω–∏–º–∞—Ä–∫–µ—Ç',
    ],
  },
  {
    name: '–†–µ—Å—Ç–æ—Ä–∞–Ω—ã –∏ –∫–∞—Ñ–µ',
    icon: 'üçΩÔ∏è',
    keywords: [
      'restaurant',
      '—Ä–µ—Å—Ç–æ—Ä–∞–Ω',
      'restoran',
      'cafe',
      '–∫–∞—Ñ–µ',
      'coffee',
      '–∫–æ—Ñ–µ',
      'kofe',
      'kebab',
      '–∫–µ–±–∞–±',
      '—à–∞—É—Ä–º–∞',
      'shawarma',
      'pizza',
      '–ø–∏—Ü—Ü–∞',
      'burger',
      '–±—É—Ä–≥–µ—Ä',
      'mcdonalds',
      '–º–∞–∫–¥–æ–Ω–∞–ª—å–¥—Å',
      'kfc',
      '–∫—Ñ—Å',
      'stolovaya',
      '—Å—Ç–æ–ª–æ–≤–∞—è',
      'canteen',
      'bistro',
      '–±–∏—Å—Ç—Ä–æ',
      'sushi',
      '—Å—É—à–∏',
      'bar',
      '–±–∞—Ä',
      'pub',
      '–ø–∞–±',
      'domino',
      '–¥–æ–º–∏–Ω–æ',
      'dodo',
      '–¥–æ–¥–æ',
      'samurai',
      '—Å–∞–º—É—Ä–∞–π',
      'oazis',
      '–æ–∞–∑–∏—Å',
      'edem',
      '—ç–¥–µ–º',
      'royal kebab',
      'marevka',
      'food',
      '—Ñ—É–¥',
      'lunch',
      '–æ–±–µ–¥',
      'dinner',
      '—É–∂–∏–Ω',
      'breakfast',
      '–∑–∞–≤—Ç—Ä–∞–∫',
    ],
  },
  {
    name: '–ó–¥–æ—Ä–æ–≤—å–µ –∏ –∞–ø—Ç–µ–∫–∏',
    icon: 'üíä',
    keywords: [
      'apteka',
      '–∞–ø—Ç–µ–∫–∞',
      'pharmacy',
      'aprel',
      '–∞–ø—Ä–µ–ª—å',
      'bioni',
      '–±–∏–æ–Ω–∏',
      'rigla',
      '—Ä–∏–≥–ª–∞',
      'doktor',
      '–¥–æ–∫—Ç–æ—Ä',
      'doctor',
      'clinic',
      '–∫–ª–∏–Ω–∏–∫–∞',
      'klinika',
      'hospital',
      '–±–æ–ª—å–Ω–∏—Ü–∞',
      'bolnica',
      'medical',
      '–º–µ–¥–∏—Ü–∏–Ω–∞',
      'medicina',
      'health',
      '–∑–¥–æ—Ä–æ–≤—å–µ',
      'zdorovye',
      'dental',
      '—Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥',
      'stomatolog',
      'optic',
      '–æ–ø—Ç–∏–∫–∞',
      'optika',
      'gorzdrav',
      '–≥–æ—Ä–∑–¥—Ä–∞–≤',
      'vita',
      '–≤–∏—Ç–∞',
      'nevis',
      '–Ω–µ–≤–∏—Å',
      'farm',
      '—Ñ–∞—Ä–º',
      'pharm',
      'lekar',
      '–ª–µ–∫–∞—Ä—å',
      'asna',
      '–∞—Å–Ω–∞',
      'skkod',
      'gbuz',
      'vash doktor',
      'beauty',
      '–∫—Ä–∞—Å–æ—Ç–∞',
      'krasota',
      'salon',
      '—Å–∞–ª–æ–Ω',
      'spa',
      '—Å–ø–∞',
      'barbershop',
      '–±–∞—Ä–±–µ—Ä—à–æ–ø',
      'haircut',
      '—Å—Ç—Ä–∏–∂–∫–∞',
      'strizhka',
      'manicure',
      '–º–∞–Ω–∏–∫—é—Ä',
      'manikyur',
      'cosmetic',
      '–∫–æ—Å–º–µ—Ç–∏–∫–∞',
      'kosmetika',
      'letual',
      '–ª–µ—Ç—É–∞–ª—å',
      'rivgosh',
      '—Ä–∏–≤ –≥–æ—à',
    ],
  },
  {
    name: '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∏ –∞–≤—Ç–æ',
    icon: 'üöó',
    keywords: [
      'azs',
      '–∞–∑—Å',
      'fuel',
      '—Ç–æ–ø–ª–∏–≤–æ',
      'benzin',
      '–±–µ–Ω–∑–∏–Ω',
      'petrol',
      'gas station',
      '–∑–∞–ø—Ä–∞–≤–∫–∞',
      'zapravka',
      'lukoil',
      '–ª—É–∫–æ–π–ª',
      'gazprom',
      '–≥–∞–∑–ø—Ä–æ–º',
      'rosneft',
      '—Ä–æ—Å–Ω–µ—Ñ—Ç—å',
      'shell',
      '—à–µ–ª–ª',
      'bp',
      'taxi',
      '—Ç–∞–∫—Å–∏',
      'taksi',
      'yandex taxi',
      '—è–Ω–¥–µ–∫—Å —Ç–∞–∫—Å–∏',
      'uber',
      '—É–±–µ—Ä',
      'citymobil',
      '—Å–∏—Ç–∏–º–æ–±–∏–ª',
      'bolt',
      '–±–æ–ª—Ç',
      'avtomojka',
      '–∞–≤—Ç–æ–º–æ–π–∫–∞',
      'car wash',
      'moyka',
      '–º–æ–π–∫–∞',
      'parking',
      '–ø–∞—Ä–∫–æ–≤–∫–∞',
      'parkovka',
      'rnazk',
      'rn azk',
      'avto',
      '–∞–≤—Ç–æ',
      'auto',
      'service',
      '—Å–µ—Ä–≤–∏—Å',
      'oil',
      '–º–∞—Å–ª–æ',
      'tire',
      '—à–∏–Ω–∞',
    ],
  },
  {
    name: '–°–≤—è–∑—å –∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç',
    icon: 'üì±',
    keywords: [
      'beeline',
      '–±–∏–ª–∞–π–Ω',
      'mts',
      '–º—Ç—Å',
      'megafon',
      '–º–µ–≥–∞—Ñ–æ–Ω',
      'tele2',
      '—Ç–µ–ª–µ2',
      'rostelecom',
      '—Ä–æ—Å—Ç–µ–ª–µ–∫–æ–º',
      'yota',
      '–π–æ—Ç–∞',
      'mobile',
      '–º–æ–±–∏–ª—å–Ω—ã–π',
      'mobilnyj',
      'telecom',
      '—Ç–µ–ª–µ–∫–æ–º',
      'internet',
      '–∏–Ω—Ç–µ—Ä–Ω–µ—Ç',
      'mbank',
      '—Å–≤—è–∑—å',
      'svyaz',
      'sms',
      '—Å–º—Å',
    ],
  },
  {
    name: '–ü–æ–¥–ø–∏—Å–∫–∏ –∏ —Å–µ—Ä–≤–∏—Å—ã',
    icon: 'üåê',
    keywords: [
      'netflix',
      '–Ω–µ—Ç—Ñ–ª–∏–∫—Å',
      'youtube',
      '—é—Ç—É–±',
      'spotify',
      '—Å–ø–æ—Ç–∏—Ñ–∞–π',
      'apple',
      '—ç–ø–ª',
      'google',
      '–≥—É–≥–ª',
      'yandex plus',
      '—è–Ω–¥–µ–∫—Å –ø–ª—é—Å',
      'subscription',
      '–ø–æ–¥–ø–∏—Å–∫–∞',
      'podpiska',
      'premium',
      '–ø—Ä–µ–º–∏—É–º',
      'reg.ru',
      '—Ä–µ–≥.—Ä—É',
      'boosty',
      '–±—É—Å—Ç–∏',
      'patreon',
      '–ø–∞—Ç—Ä–µ–æ–Ω',
      'steam',
      '—Å—Ç–∏–º',
      'playstation',
      '–ø–ª–µ–π—Å—Ç–µ–π—à–Ω',
      'xbox',
      '–∏–∫—Å–±–æ–∫—Å',
      '–ø–ª–∞—Ç–∏ –ø–æ –º–∏—Ä—É',
      'timeweb',
      'hosting',
      '—Ö–æ—Å—Ç–∏–Ω–≥',
      'domain',
      '–¥–æ–º–µ–Ω',
      'vps',
      'server',
      '—Å–µ—Ä–≤–µ—Ä',
    ],
  },
  {
    name: '–û–¥–µ–∂–¥–∞ –∏ –æ–±—É–≤—å',
    icon: 'üëï',
    keywords: [
      'zara',
      '–∑–∞—Ä–∞',
      'hm',
      'h&m',
      'asos',
      '–∞—Å–æ—Å',
      'lamoda',
      '–ª–∞–º–æ–¥–∞',
      'wildberries',
      '–≤–∞–π–ª–¥–±–µ—Ä—Ä–∏–∑',
      'wb',
      '–≤–±',
      'ozon',
      '–æ–∑–æ–Ω',
      'clothing',
      '–æ–¥–µ–∂–¥–∞',
      'odezhda',
      'shoes',
      '–æ–±—É–≤—å',
      'obuv',
      'fashion',
      '–º–æ–¥–∞',
      'moda',
      'sportmaster',
      '—Å–ø–æ—Ä—Ç–º–∞—Å—Ç–µ—Ä',
      'adidas',
      '–∞–¥–∏–¥–∞—Å',
      'nike',
      '–Ω–∞–π–∫',
      'uniqlo',
      '—é–Ω–∏–∫–ª–æ',
      'bershka',
      '–±–µ—Ä—à–∫–∞',
      'pullandbear',
      '–ø—É–ª —ç–Ω–¥ –±–∏—Ä',
      'elegiya',
      '—ç–ª–µ–≥–∏—è',
    ],
  },
  {
    name: '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è',
    icon: 'üéÆ',
    keywords: [
      'cinema',
      '–∫–∏–Ω–æ',
      'kino',
      'theatre',
      '—Ç–µ–∞—Ç—Ä',
      'teatr',
      'concert',
      '–∫–æ–Ω—Ü–µ—Ä—Ç',
      'koncert',
      'museum',
      '–º—É–∑–µ–π',
      'muzey',
      'park',
      '–ø–∞—Ä–∫',
      'zoo',
      '–∑–æ–æ–ø–∞—Ä–∫',
      'game',
      '–∏–≥—Ä–∞',
      'igra',
      'gaming',
      '–≥–µ–π–º–∏–Ω–≥',
      'entertainment',
      '—Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏–µ',
      'razvlechenie',
      'bowling',
      '–±–æ—É–ª–∏–Ω–≥',
      'billiard',
      '–±–∏–ª—å—è—Ä–¥',
      'karaoke',
      '–∫–∞—Ä–∞–æ–∫–µ',
      'quest',
      '–∫–≤–µ—Å—Ç',
      'club',
      '–∫–ª—É–±',
      'disco',
      '–¥–∏—Å–∫–æ',
      'shariki',
      '—à–∞—Ä–∏–∫–∏',
    ],
  },
  {
    name: '–ü–µ—Ä–µ–≤–æ–¥—ã –∏—Å—Ö–æ–¥—è—â–∏–µ',
    icon: 'üí∏',
    keywords: [
      '–ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞',
      '–ø–æ –Ω–æ–º–µ—Ä—É –∫–∞—Ä—Ç—ã',
      '–ø–µ—Ä–µ–≤–æ–¥ –ø–æ –Ω–æ–º–µ—Ä—É',
      '–≤–Ω–µ—à–Ω–∏–π –ø–µ—Ä–µ–≤–æ–¥',
      '–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–µ—Ä–µ–≤–æ–¥',
      '–≤–Ω—É—Ç—Ä–∏–±–∞–Ω–∫–æ–≤—Å–∫–∏–π',
      '–ø–µ—Ä–µ–≤–æ–¥',
      'perevod',
      'transfer',
      '—Ç—Ä–∞–Ω—Å—Ñ–µ—Ä',
      '—Å–±–ø',
      'sbp',
      'p2p',
      '–Ω–∞ –∫–∞—Ä—Ç—É',
      'na kartu',
    ],
  },
  {
    name: '–ñ–∏–ª—å—ë –∏ –ñ–ö–•',
    icon: 'üè†',
    keywords: [
      'ikea',
      '–∏–∫–µ–∞',
      'leroy',
      '–ª–µ—Ä—É–∞',
      'obi',
      '–æ–±–∏',
      'petrovich',
      '–ø–µ—Ç—Ä–æ–≤–∏—á',
      'stroymarket',
      '—Å—Ç—Ä–æ–π–º–∞—Ç–µ—Ä–∏–∞–ª',
      'stroymaterial',
      'building',
      '—Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–π',
      'stroitelnyj',
      'remont',
      '—Ä–µ–º–æ–Ω—Ç',
      'repair',
      'furniture',
      '–º–µ–±–µ–ª—å',
      'mebel',
      'home',
      '–¥–æ–º',
      'dom',
      'houseware',
      '—Ö–æ–∑—Ç–æ–≤–∞—Ä—ã',
      'hoztovary',
      'birloga',
      '–±–µ—Ä–ª–æ–≥–∞',
      'zhkh',
      '–∂–∫—Ö',
      'communal',
      '–∫–æ–º–º—É–Ω–∞–ª—å–Ω',
      'kommunaln',
      'electricity',
      '—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ',
      'elektrichestvo',
      'water',
      '–≤–æ–¥–∞',
      'voda',
      'heating',
      '–æ—Ç–æ–ø–ª–µ–Ω–∏–µ',
      'otoplenie',
      'rent',
      '–∞—Ä–µ–Ω–¥–∞',
      'arenda',
      'utility',
      '—É—Å–ª—É–≥–∏',
      'uslugi',
      'uk ',
      '—É–∫ ',
      'tszh',
      '—Ç—Å–∂',
      'mos.ru',
      '–º–æ—Å.—Ä—É',
      'gosuslugi',
      '–≥–æ—Å—É—Å–ª—É–≥–∏',
    ],
  },
  {
    name: '–¢–µ—Ö–Ω–∏–∫–∞',
    icon: 'üñ•Ô∏è',
    keywords: [
      'eldorado',
      '—ç–ª—å–¥–æ—Ä–∞–¥–æ',
      'mvideo',
      '–º–≤–∏–¥–µ–æ',
      'm.video',
      '–º.–≤–∏–¥–µ–æ',
      'dns',
      '–¥–Ω—Å',
      'citilink',
      '—Å–∏—Ç–∏–ª–∏–Ω–∫',
      'technopark',
      '—Ç–µ—Ö–Ω–æ–ø–∞—Ä–∫',
      're:store',
      'restore',
      'electronics',
      '—ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞',
      'elektronika',
      'gadget',
      '–≥–∞–¥–∂–µ—Ç',
      'phone',
      '—Ç–µ–ª–µ—Ñ–æ–Ω',
      'telefon',
      'computer',
      '–∫–æ–º–ø—å—é—Ç–µ—Ä',
      'kompyuter',
      'laptop',
      '–Ω–æ—É—Ç–±—É–∫',
      'noutbuk',
    ],
  },
  {
    name: '–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ',
    icon: 'üìö',
    keywords: [
      'education',
      '–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ',
      'obrazovanie',
      'school',
      '—à–∫–æ–ª–∞',
      'shkola',
      'university',
      '—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç',
      'universitet',
      'college',
      '–∫–æ–ª–ª–µ–¥–∂',
      'kolledzh',
      'course',
      '–∫—É—Ä—Å',
      'kurs',
      'training',
      '–æ–±—É—á–µ–Ω–∏–µ',
      'obuchenie',
      'book',
      '–∫–Ω–∏–≥–∞',
      'kniga',
      'library',
      '–±–∏–±–ª–∏–æ—Ç–µ–∫–∞',
      'biblioteka',
      'study',
      '—É—á–µ–±–∞',
      'ucheba',
      'tutor',
      '—Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä',
      'repetitor',
    ],
  },
  {
    name: '–ö—Ä–µ–¥–∏—Ç—ã –∏ –∑–∞–π–º—ã',
    icon: 'üè¶',
    keywords: [
      '–∫—Ä–µ–¥–∏—Ç',
      'kredit',
      'credit',
      '–∑–∞–π–º',
      'zaym',
      'loan',
      '–∏–ø–æ—Ç–µ–∫–∞',
      'ipoteka',
      'mortgage',
      '–ø–æ–≥–∞—à–µ–Ω–∏–µ',
      '–ø–æ–≥–∞—à–µ–Ω',
      '—Ä–∞—Å—Å—Ä–æ—á–∫–∞',
      'rassrochka',
      'installment',
      '–¥–æ–ª–≥',
      'dolg',
      'debt',
      '–ø–ª–∞—Ç—ë–∂ –ø–æ –∫—Ä–µ–¥–∏—Ç—É',
      '–ø–ª–∞—Ç–µ–∂ –ø–æ –∫—Ä–µ–¥–∏—Ç—É',
      '–≤—ã–ø–ª–∞—Ç–∞ –∫—Ä–µ–¥–∏—Ç–∞',
      '—Å–ø–∏—Å–∞–Ω–∏–µ',
    ],
  },
  {
    name: '–°–Ω—è—Ç–∏–µ –Ω–∞–ª–∏—á–Ω—ã—Ö',
    icon: 'üíµ',
    keywords: [
      'atm',
      '–±–∞–Ω–∫–æ–º–∞—Ç',
      'bankomat',
      'cash',
      '–Ω–∞–ª–∏—á–Ω—ã–µ',
      'nalichnye',
      'withdrawal',
      '—Å–Ω—è—Ç–∏–µ',
      'snyatie',
      '–≤—ã–¥–∞—á–∞',
      'vydacha',
    ],
  },
];

// Universal income categories (synchronized with AI prompt)
const INCOME_CATEGORIES: CategoryMapping[] = [
  {
    name: '–ó–∞—Ä–ø–ª–∞—Ç–∞',
    icon: 'üí∞',
    keywords: [
      'salary',
      '–∑–∞—Ä–ø–ª–∞—Ç–∞',
      'zarplata',
      'payroll',
      '–æ–∫–ª–∞–¥',
      'oklad',
      'wage',
      '–∑–∞—Ä–∞–±–æ—Ç–Ω',
      'zarabotn',
      'rocket work',
      'rocketwork',
      '–≥–æ–Ω–æ—Ä–∞—Ä',
      'honorar',
      '–≤—ã–ø–ª–∞—Ç–∞',
      'vyplata',
      '–∞–≤–∞–Ω—Å',
      'avans',
    ],
  },
  {
    name: '–ü–µ—Ä–µ–≤–æ–¥—ã –≤—Ö–æ–¥—è—â–∏–µ',
    icon: 'üí∏',
    keywords: [
      '–ø–µ—Ä–µ–≤–æ–¥',
      'perevod',
      'transfer',
      '—Ç—Ä–∞–Ω—Å—Ñ–µ—Ä',
      '—Å–±–ø',
      'sbp',
      'p2p',
      '–æ—Ç ',
      '—Å –∫–∞—Ä—Ç—ã',
      's karty',
      '–≤–Ω–µ—à–Ω–∏–π –ø–µ—Ä–µ–≤–æ–¥',
      '–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–µ—Ä–µ–≤–æ–¥',
      '–≤–Ω—É—Ç—Ä–∏–±–∞–Ω–∫–æ–≤—Å–∫–∏–π',
      '–ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ',
      'popolnenie',
    ],
  },
  {
    name: '–ö—ç—à–±—ç–∫ –∏ –≤–æ–∑–≤—Ä–∞—Ç',
    icon: 'üîÑ',
    keywords: [
      'refund',
      '–≤–æ–∑–≤—Ä–∞—Ç',
      'vozvrat',
      'cashback',
      '–∫—ç—à–±—ç–∫',
      '–∫–µ—à–±—ç–∫',
      'return',
      '–æ—Ç–º–µ–Ω–∞',
      'otmena',
      '–±–æ–Ω—É—Å',
      'bonus',
    ],
  },
  {
    name: '–ü—Ä–æ—Ü–µ–Ω—Ç—ã –∏ –¥–∏–≤–∏–¥–µ–Ω–¥—ã',
    icon: 'üìà',
    keywords: [
      'interest',
      '–ø—Ä–æ—Ü–µ–Ω—Ç',
      'procent',
      'dividend',
      '–¥–∏–≤–∏–¥–µ–Ω–¥',
      '–≤–∫–ª–∞–¥',
      'vklad',
      'deposit',
      '–¥–µ–ø–æ–∑–∏—Ç',
      '–∫–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è',
    ],
  },
];

// Default categories (synchronized with AI prompt)
const DEFAULT_EXPENSE: CategoryResult = {
  name: '–ü—Ä–æ—á–∏–µ —Ä–∞—Å—Ö–æ–¥—ã',
  icon: 'üì¶',
  confidence: 'low',
};

const DEFAULT_INCOME: CategoryResult = {
  name: '–ü—Ä–æ—á–∏–µ –¥–æ—Ö–æ–¥—ã',
  icon: 'üì•',
  confidence: 'low',
};

@Injectable()
export class CategoryMapper {
  /**
   * Map description to category for expense transactions
   * Returns confidence level to indicate if AI fallback might be needed
   */
  mapExpenseCategory(description: string): CategoryResult {
    const lowerDesc = description.toLowerCase();

    for (const category of EXPENSE_CATEGORIES) {
      for (const keyword of category.keywords) {
        if (lowerDesc.includes(keyword.toLowerCase())) {
          return {
            name: category.name,
            icon: category.icon,
            confidence: 'high',
          };
        }
      }
    }

    return DEFAULT_EXPENSE;
  }

  /**
   * Map description to category for income transactions
   * Returns confidence level to indicate if AI fallback might be needed
   */
  mapIncomeCategory(description: string): CategoryResult {
    const lowerDesc = description.toLowerCase();

    for (const category of INCOME_CATEGORIES) {
      for (const keyword of category.keywords) {
        if (lowerDesc.includes(keyword.toLowerCase())) {
          return {
            name: category.name,
            icon: category.icon,
            confidence: 'high',
          };
        }
      }
    }

    return DEFAULT_INCOME;
  }

  /**
   * Map description to category based on transaction type
   * Returns confidence level to indicate if AI fallback might be needed
   */
  mapCategory(description: string, type: 'INCOME' | 'EXPENSE'): CategoryResult {
    if (type === 'INCOME') {
      return this.mapIncomeCategory(description);
    }
    return this.mapExpenseCategory(description);
  }

  /**
   * Check if result needs AI categorization (low confidence)
   */
  needsAiCategorization(result: CategoryResult): boolean {
    return result.confidence === 'low';
  }

  /**
   * Get all available expense category names
   */
  getExpenseCategories(): string[] {
    return [...EXPENSE_CATEGORIES.map((c) => c.name), DEFAULT_EXPENSE.name];
  }

  /**
   * Get all available income category names
   */
  getIncomeCategories(): string[] {
    return [...INCOME_CATEGORIES.map((c) => c.name), DEFAULT_INCOME.name];
  }

  /**
   * Normalize Sberbank category to universal category
   */
  normalizeSberCategory(
    sberCategory: string,
    description: string,
    type: 'INCOME' | 'EXPENSE',
  ): CategoryResult {
    // Map Sberbank-specific categories to universal ones
    const sberToUniversal: Record<string, { name: string; icon: string }> = {
      // –†–∞—Å—Ö–æ–¥—ã
      –°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç—ã: { name: '–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç—ã', icon: 'üõí' },
      '–†–µ—Å—Ç–æ—Ä–∞–Ω—ã –∏ –∫–∞—Ñ–µ': { name: '–†–µ—Å—Ç–æ—Ä–∞–Ω—ã –∏ –∫–∞—Ñ–µ', icon: 'üçΩÔ∏è' },
      '–ü–µ—Ä–µ–≤–æ–¥ –°–ë–ü': { name: '–ü–µ—Ä–µ–≤–æ–¥—ã –∏—Å—Ö–æ–¥—è—â–∏–µ', icon: 'üí∏' },
      '–ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ –∫–∞—Ä—Ç—É': { name: '–ü–µ—Ä–µ–≤–æ–¥—ã –∏—Å—Ö–æ–¥—è—â–∏–µ', icon: 'üí∏' },
      '–í—ã–¥–∞—á–∞ –Ω–∞–ª–∏—á–Ω—ã—Ö': { name: '–°–Ω—è—Ç–∏–µ –Ω–∞–ª–∏—á–Ω—ã—Ö', icon: 'üíµ' },
      '–û–ø–ª–∞—Ç–∞ –ø–æ QR‚Äì–∫–æ–¥—É –°–ë–ü': { name: '–ü–µ—Ä–µ–≤–æ–¥—ã –∏—Å—Ö–æ–¥—è—â–∏–µ', icon: 'üí∏' },
      '–û–ø–ª–∞—Ç–∞ –ø–æ QR-–∫–æ–¥—É –°–ë–ü': { name: '–ü–µ—Ä–µ–≤–æ–¥—ã –∏—Å—Ö–æ–¥—è—â–∏–µ', icon: 'üí∏' },
      –ê–≤—Ç–æ–º–æ–±–∏–ª—å: { name: '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∏ –∞–≤—Ç–æ', icon: 'üöó' },
      '–û–¥–µ–∂–¥–∞ –∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã': { name: '–û–¥–µ–∂–¥–∞ –∏ –æ–±—É–≤—å', icon: 'üëï' },
      '–û—Ç–¥—ã—Ö –∏ —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è': { name: '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è', icon: 'üéÆ' },
      '–ó–¥–æ—Ä–æ–≤—å–µ –∏ –∫—Ä–∞—Å–æ—Ç–∞': { name: '–ó–¥–æ—Ä–æ–≤—å–µ –∏ –∞–ø—Ç–µ–∫–∏', icon: 'üíä' },
      '–í—Å–µ –¥–ª—è –¥–æ–º–∞': { name: '–ñ–∏–ª—å—ë –∏ –ñ–ö–•', icon: 'üè†' },
      '–°–≤—è–∑—å –∏ —Ç–µ–ª–µ–∫–æ–º': { name: '–°–≤—è–∑—å –∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç', icon: 'üì±' },
      –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç: { name: '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∏ –∞–≤—Ç–æ', icon: 'üöó' },
      –ñ–ö–•: { name: '–ñ–∏–ª—å—ë –∏ –ñ–ö–•', icon: 'üè†' },
      –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ: { name: '–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ', icon: 'üìö' },
      '–ü—Ä–æ—á–∏–µ —Ä–∞—Å—Ö–æ–¥—ã': { name: '–ü—Ä–æ—á–∏–µ —Ä–∞—Å—Ö–æ–¥—ã', icon: 'üì¶' },
      // –î–æ—Ö–æ–¥—ã
      '–ü–µ—Ä–µ–≤–æ–¥ —Å –∫–∞—Ä—Ç—ã': { name: '–ü–µ—Ä–µ–≤–æ–¥—ã –≤—Ö–æ–¥—è—â–∏–µ', icon: 'üí∏' },
      '–ü—Ä–æ—á–∏–µ –¥–æ—Ö–æ–¥—ã': { name: '–ü—Ä–æ—á–∏–µ –¥–æ—Ö–æ–¥—ã', icon: 'üì•' },
    };

    // First try to map Sberbank category
    if (sberCategory && sberToUniversal[sberCategory]) {
      const mapped = sberToUniversal[sberCategory];
      return { ...mapped, confidence: 'high' };
    }

    // If no match, try to determine from description
    return this.mapCategory(description, type);
  }
}
